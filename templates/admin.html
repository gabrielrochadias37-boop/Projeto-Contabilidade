{% extends "base.html" %}
{% block title %}Administração{% endblock %}
{% block content %}
<section id="admin" class="tab-content active">
  <div class="page-header">
    <h1>Administração</h1>
    <p>Cadastro de usuários e empresas</p>
  </div>

  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-user-plus"></i> Cadastrar Usuário</h3>
    </div>
    <form action="{{ url_for('admin.create_user') }}" method="post" class="form-grid">
      <div class="form-group">
        <label for="u_nome">Nome</label>
        <input id="u_nome" name="nome" type="text" required>
      </div>
      <div class="form-group">
        <label for="u_login">Login</label>
        <input id="u_login" name="login" type="text" required>
      </div>
      <div class="form-group">
        <label for="u_senha">Senha</label>
        <input id="u_senha" name="senha" type="password" required>
      </div>
      <div class="form-group">
        <label for="u_tipo">Tipo</label>
        <select id="u_tipo" name="tipo" required>
          <option value="normal">Normal</option>
          <option value="gerente">Gerente</option>
        </select>
      </div>
      <div class="form-group">
        <label for="u_setor">Setor</label>
        <select id="u_setor" name="setor_id">
          {% for s in setores %}
          <option value="{{ s.id }}">{{ s.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Salvar Usuário</button>
      </div>
    </form>
  </div>

  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-building"></i> Cadastrar Empresa</h3>
    </div>
    <form action="{{ url_for('admin.create_company') }}" method="post" class="form-grid">
      <div class="form-group">
        <label for="e_codigo">Código</label>
        <input id="e_codigo" name="codigo" type="text" required>
      </div>
      <div class="form-group">
        <label for="e_nome">Nome</label>
        <input id="e_nome" name="nome" type="text" required>
      </div>
      <div class="form-group">
        <label for="e_trib">Tributação</label>
        <select id="e_trib" name="tributacao_id" required>
          {% for t in tributacoes %}
          <option value="{{ t.id }}">{{ t.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Salvar Empresa</button>
      </div>
    </form>
  </div>

  <div class="content-card">
    <div class="card-header">
      <h3>Usuários</h3>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr><th>Nome</th><th>Login</th><th>Tipo</th><th>Setor</th><th>Status</th><th>Ações</th></tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
          <tr>
            <td>{{ u.nome }}</td>
            <td>{{ u.login }}</td>
            <td>{{ u.tipo|capitalize }}</td>
            <td>{% set s = setores|selectattr('id','equalto',u.setor_id)|first %}{{ s.nome if s else '-' }}</td>
            <td>
              <span class="status-badge {{ 'status-active' if u.ativo else 'status-inactive' }}">{{ 'Ativo' if u.ativo else 'Inativo' }}</span>
            </td>
            <td>
              <form action="{{ url_for('admin.toggle_user', user_id=u.id) }}" method="post">
                <button type="submit" class="btn {{ 'btn-secondary' if u.ativo else 'btn-primary' }}">{{ 'Desativar' if u.ativo else 'Ativar' }}</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="content-card">
    <div class="card-header">
      <h3>Empresas</h3>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr><th>Código</th><th>Nome</th><th>Tributação</th><th>Status</th><th>Ações</th></tr>
        </thead>
        <tbody>
          {% for e in empresas %}
          <tr>
            <td>{{ e.codigo }}</td>
            <td>{{ e.nome }}</td>
            <td>{% set tr = tributacoes|selectattr('id','equalto',e.tributacao_id)|first %}{{ tr.nome if tr else '-' }}</td>
            <td>
              <span class="status-badge {{ 'status-active' if e.ativo else 'status-inactive' }}">{{ 'Ativa' if e.ativo else 'Inativa' }}</span>
            </td>
            <td>
              <form action="{{ url_for('admin.toggle_company', empresa_id=e.id) }}" method="post">
                <button type="submit" class="btn {{ 'btn-secondary' if e.ativo else 'btn-primary' }}">{{ 'Desativar' if e.ativo else 'Ativar' }}</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}
