{% extends "base.html" %}

{% block title %}Tarefas{% endblock %}

{% block content %}
<section id="tarefas" class="tab-content active">
  <div class="page-header">
    <h1>Tarefas</h1>
    <p>Gerencie as tarefas por setor e tributação, e personalize por empresa</p>
  </div>

  <!-- Resumo -->
  <div class="content-card">
    <div class="card-header"><h3><i class="fas fa-chart-bar"></i> Resumo de Tarefas</h3></div>
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
      <div class="metric-card">
        <div class="metric-icon contas"><i class="fas fa-clipboard-list"></i></div>
        <div class="metric-content">
          <h3>Tarefas Globais</h3>
          <div class="metric-value">{{ tarefas|length if tarefas else 0 }}</div>
          <div class="metric-change neutral"><i class="fas fa-globe"></i> Modelos</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon pendentes"><i class="fas fa-building"></i></div>
        <div class="metric-content">
          <h3>Vinculadas a Empresas</h3>
          <div class="metric-value">{{ rels|length if rels else 0 }}</div>
          <div class="metric-change warning"><i class="fas fa-link"></i> Relacionamentos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cadastro de Tarefa (modelo) -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-plus-circle"></i> Adicionar Nova Tarefa (Modelo)</h3>
      <div class="card-actions">
        <button type="button" class="btn btn-secondary" onclick="toggleForm('tarefaFormContainer')">
          <span id="toggle-icon-tarefaFormContainer">+</span> Expandir Formulário
        </button>
      </div>
    </div>
    <div id="tarefaFormContainer" class="hidden">
      <form action="{{ url_for('accounts.create_task') }}" method="post" class="form-grid" id="tarefaForm">
        <div class="form-group">
          <label for="tarefa_nome">Nome da Tarefa</label>
          <input type="text" id="tarefa_nome" name="nome" placeholder="Ex: Apuração ICMS" required>
        </div>
        <div class="form-group">
          <label for="tarefa_tipo">Tipo</label>
          <select id="tarefa_tipo" name="tipo" required>
            <option value="Mensal">Mensal</option>
            <option value="Trimestral">Trimestral</option>
            <option value="Anual">Anual</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tarefa_setor">Setor</label>
          <select id="tarefa_setor" name="setor_id" required>
            {% for s in setores or [] %}
              <option value="{{ s.id }}">{{ s.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="tarefa_trib">Tributação</label>
          <select id="tarefa_trib" name="tributacao_id" required>
            {% for t in tributacoes or [] %}
              <option value="{{ t.id }}">{{ t.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label for="tarefa_desc">Descrição</label>
          <textarea id="tarefa_desc" name="descricao" rows="3" placeholder="Detalhes importantes..."></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Adicionar Tarefa</button>
          <button type="reset" class="btn btn-secondary"><i class="fas fa-undo"></i> Limpar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Relacionar Tarefa a Empresa/Responsável -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-link"></i> Vincular Tarefa a Empresa</h3>
    </div>
    <form action="{{ url_for('accounts.link_task') }}" method="post" class="form-grid">
      <div class="form-group">
        <label for="empresa_id">Empresa</label>
        <select id="empresa_id" name="empresa_id" required>
          {% for e in empresas or [] %}
            <option value="{{ e.id }}">{{ e.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="tarefa_id">Tarefa</label>
        <select id="tarefa_id" name="tarefa_id" required>
          {% for t in tarefas or [] %}
            <option value="{{ t.id }}">{{ t.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="responsavel_id">Responsável</label>
        <select id="responsavel_id" name="responsavel_id">
          <option value="">— Opcional —</option>
          {% for u in usuarios or [] %}
            <option value="{{ u.id }}">{{ u.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="dia_venc">Dia de Vencimento</label>
        <input type="number" id="dia_venc" name="dia_vencimento" min="1" max="31" placeholder="Ex: 20">
      </div>
      <div class="form-group">
        <label for="prazo_esp">Prazo Específico</label>
        <input type="date" id="prazo_esp" name="prazo_especifico">
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary"><i class="fas fa-link"></i> Vincular</button>
      </div>
    </form>
  </div>

  <!-- Lista de Tarefas (Modelos) -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-globe"></i> Tarefas (Modelos)</h3>
      <div class="card-actions">
        <span class="status-badge status-active">{{ tarefas|length if tarefas else 0 }} tarefas</span>
      </div>
    </div>
    <div class="table-container">
      {% if tarefas %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Setor</th>
            <th>Tributação</th>
            <th>Tipo</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tarefas %}
          <tr>
            <td><strong>{{ t.nome }}</strong></td>
            <td>{{ t.setor_nome }}</td>
            <td>{{ t.tributacao_nome }}</td>
            <td>{{ t.tipo }}</td>
            <td>
              <div class="card-actions">
                <button type="button" class="btn btn-outline" data-toggle-edit="editTask-{{ t.id }}"><i class="fas fa-edit"></i></button>
                <form action="{{ url_for('accounts.delete_task') }}" method="post" style="display:inline;" onsubmit="return confirm('Excluir esta tarefa modelo?');">
                  <input type="hidden" name="id" value="{{ t.id }}">
                  <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          <tr id="editTask-{{ t.id }}" class="edit-form-row hidden">
            <td colspan="5">
              <div class="card-header"><h4><i class="fas fa-edit"></i> Editando: {{ t.nome }}</h4></div>
              <form action="{{ url_for('accounts.edit_task') }}" method="post" class="form-grid">
                <input type="hidden" name="id" value="{{ t.id }}">
                <div class="form-group">
                  <label>Nome</label>
                  <input type="text" name="nome" value="{{ t.nome }}" required>
                </div>
                <div class="form-group">
                  <label>Tipo</label>
                  <select name="tipo">
                    <option value="Mensal" {% if t.tipo=='Mensal' %}selected{% endif %}>Mensal</option>
                    <option value="Trimestral" {% if t.tipo=='Trimestral' %}selected{% endif %}>Trimestral</option>
                    <option value="Anual" {% if t.tipo=='Anual' %}selected{% endif %}>Anual</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Setor</label>
                  <select name="setor_id">
                    {% for s in setores or [] %}
                      <option value="{{ s.id }}" {% if s.id==t.setor_id %}selected{% endif %}>{{ s.nome }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label>Tributação</label>
                  <select name="tributacao_id">
                    {% for tr in tributacoes or [] %}
                      <option value="{{ tr.id }}" {% if tr.id==t.tributacao_id %}selected{% endif %}>{{ tr.nome }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label>Descrição</label>
                  <textarea name="descricao" rows="3">{{ t.descricao or '' }}</textarea>
                </div>
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                  <button type="button" class="btn btn-secondary" data-cancel-edit="editTask-{{ t.id }}"><i class="fas fa-times"></i> Cancelar</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="info-text"><i class="fas fa-info-circle"></i> Nenhuma tarefa modelo registrada ainda.</p>
      {% endif %}
    </div>
  </div>

  <!-- Relacionamentos (por empresa) -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-building"></i> Tarefas por Empresa</h3>
      <div class="card-actions">
        <span class="status-badge status-pending">{{ rels|length if rels else 0 }} vínculos</span>
      </div>
    </div>
    <div class="table-container">
      {% if rels %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Tarefa</th>
            <th>Responsável</th>
            <th>Status</th>
            <th>Vencimento</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rels %}
          <tr>
            <td>{{ r.empresa_nome }}</td>
            <td>{{ r.tarefa_nome }}</td>
            <td>{{ r.responsavel_nome or '-' }}</td>
            <td><span class="status-badge {{ 'status-active' if r.status=='ativa' else 'status-inactive' }}">{{ r.status|capitalize }}</span></td>
            <td>{{ r.prazo_especifico or ('Dia ' ~ r.dia_vencimento if r.dia_vencimento else '-') }}</td>
            <td>
              <div class="card-actions">
                <button type="button" class="btn btn-outline" data-toggle-edit="editRel-{{ r.id }}"><i class="fas fa-edit"></i></button>
                <form action="{{ url_for('accounts.delete_link') }}" method="post" style="display:inline;" onsubmit="return confirm('Remover vínculo desta tarefa com a empresa?');">
                  <input type="hidden" name="id" value="{{ r.id }}">
                  <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          <tr id="editRel-{{ r.id }}" class="edit-form-row hidden">
            <td colspan="6">
              <div class="card-header"><h4><i class="fas fa-edit"></i> Editar Vínculo</h4></div>
              <form action="{{ url_for('accounts.edit_link') }}" method="post" class="form-grid">
                <input type="hidden" name="id" value="{{ r.id }}">
                <div class="form-group">
                  <label>Status</label>
                  <select name="status">
                    <option value="ativa" {% if r.status=='ativa' %}selected{% endif %}>Ativa</option>
                    <option value="inativa" {% if r.status=='inativa' %}selected{% endif %}>Inativa</option>
                    <option value="suspensa" {% if r.status=='suspensa' %}selected{% endif %}>Suspensa</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Responsável</label>
                  <select name="responsavel_id">
                    <option value="">— Nenhum —</option>
                    {% for u in usuarios or [] %}
                      <option value="{{ u.id }}" {% if r.responsavel_id==u.id %}selected{% endif %}>{{ u.nome }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label>Dia de Vencimento</label>
                  <input type="number" name="dia_vencimento" min="1" max="31" value="{{ r.dia_vencimento or '' }}">
                </div>
                <div class="form-group">
                  <label>Prazo Específico</label>
                  <input type="date" name="prazo_especifico" value="{{ r.prazo_especifico or '' }}">
                </div>
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                  <button type="button" class="btn btn-secondary" data-cancel-edit="editRel-{{ r.id }}"><i class="fas fa-times"></i> Cancelar</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="info-text"><i class="fas fa-info-circle"></i> Nenhum vínculo de tarefa com empresa ainda.</p>
      {% endif %}
    </div>
  </div>

</section>
{% endblock %}